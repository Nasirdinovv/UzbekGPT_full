<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>O'zbekGPT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { font-family: 'DM Sans', sans-serif; box-sizing: border-box; }
    h1, h2, .brand { font-family: 'Syne', sans-serif; }
    code, pre { font-family: 'JetBrains Mono', monospace; }

    html, body { height: 100%; margin: 0; }
    body { background: #08080e; color: #e2e8f0; display: flex; }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    #sidebar {
      width: 260px; flex-shrink: 0;
      background: rgba(255,255,255,.03);
      border-right: 1px solid rgba(255,255,255,.06);
      display: flex; flex-direction: column;
      height: 100vh;
      transition: transform .3s;
    }

    .sidebar-header {
      padding: 20px 16px 16px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .logo-ring {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 16px rgba(99,102,241,.4);
      flex-shrink: 0;
    }

    .new-chat-btn {
      display: flex; align-items: center; gap:8px;
      background: rgba(99,102,241,.12);
      border: 1px solid rgba(99,102,241,.25);
      color: #a5b4fc;
      border-radius: 10px;
      padding: 9px 14px;
      font-size: 13px; font-weight: 500;
      cursor: pointer;
      transition: all .2s;
      text-decoration: none;
      margin: 12px 12px 8px;
      width: calc(100% - 24px);
      justify-content: center;
    }
    .new-chat-btn:hover {
      background: rgba(99,102,241,.22);
      border-color: rgba(99,102,241,.5);
      color: #c7d2fe;
    }

    .sessions-list { flex: 1; overflow-y: auto; padding: 4px 8px; }
    .sessions-list::-webkit-scrollbar { width: 4px; }
    .sessions-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 4px; }

    .session-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; border-radius: 8px;
      cursor: pointer; transition: background .2s;
      margin-bottom: 2px; gap: 8px;
    }
    .session-item:hover { background: rgba(255,255,255,.06); }
    .session-item.active { background: rgba(99,102,241,.15); border: 1px solid rgba(99,102,241,.2); }

    .session-title {
      font-size: 12.5px; color: #94a3b8;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      flex: 1;
    }
    .session-item.active .session-title { color: #c7d2fe; }

    .del-btn {
      opacity: 0; color: #64748b; cursor: pointer;
      transition: opacity .2s, color .2s;
      flex-shrink: 0; background: none; border: none; padding: 2px;
    }
    .session-item:hover .del-btn { opacity: 1; }
    .del-btn:hover { color: #f87171; }

    .sidebar-footer {
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.06);
    }

    .user-badge {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 10px; border-radius: 10px;
      background: rgba(255,255,255,.04);
    }
    .avatar {
      width: 32px; height: 32px; border-radius: 8px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 700; color: white;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    #main { flex: 1; display: flex; flex-direction: column; height: 100vh; min-width: 0; }

    /* ‚îÄ‚îÄ Messages ‚îÄ‚îÄ */
    #messages {
      flex: 1; overflow-y: auto;
      padding: 32px 0;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 4px; }
    #messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,.08); border-radius: 4px; }

    .message-wrap { max-width: 760px; margin: 0 auto; padding: 0 24px; }

    .msg-row { display: flex; gap: 12px; margin-bottom: 24px; animation: msgIn .3s ease both; }
    .msg-row.user { flex-direction: row-reverse; }

    @keyframes msgIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg-avatar {
      width: 32px; height: 32px; border-radius: 8px;
      flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 700;
    }
    .msg-avatar.ai {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 4px 12px rgba(99,102,241,.35);
    }
    .msg-avatar.user-av {
      background: linear-gradient(135deg, #06b6d4, #0284c7);
      box-shadow: 0 4px 12px rgba(6,182,212,.3);
    }

    .msg-bubble {
      max-width: 80%; padding: 12px 16px;
      border-radius: 16px; font-size: 14px; line-height: 1.65;
    }
    .msg-row.user .msg-bubble {
      background: linear-gradient(135deg, #1e40af, #1d4ed8);
      border: 1px solid rgba(59,130,246,.3);
      color: #dbeafe;
      border-top-right-radius: 4px;
    }
    .msg-row.ai .msg-bubble {
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      color: #cbd5e1;
      border-top-left-radius: 4px;
    }

    /* LINK VA MARKDOWN UCHUN STYLELAR */
    .msg-bubble a { color: #818cf8; text-decoration: underline; font-weight: 500; }
    .msg-bubble a:hover { color: #a5b4fc; }
    .msg-bubble ul, .msg-bubble ol { margin-left: 20px; }
    .msg-bubble li { list-style: disc; }

    .msg-bubble pre {
      background: rgba(0,0,0,.4);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 8px;
      padding: 12px; margin: 8px 0;
      overflow-x: auto; font-size: 12px;
    }

    /* ‚îÄ‚îÄ Welcome screen ‚îÄ‚îÄ */
    #welcome {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 40px 24px;
    }

    .welcome-logo {
      width: 72px; height: 72px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 20px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 16px 48px rgba(99,102,241,.4);
      margin-bottom: 20px;
    }

    .suggestion-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 24px; width: 100%; max-width: 520px; }
    .suggestion-card {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px; padding: 14px 16px;
      cursor: pointer; transition: all .2s;
      font-size: 13px; color: #94a3b8;
      text-align: left;
    }
    .suggestion-card:hover {
      background: rgba(99,102,241,.1);
      border-color: rgba(99,102,241,.3);
      color: #c7d2fe;
      transform: translateY(-2px);
    }
    .suggestion-card .icon { font-size: 20px; margin-bottom: 6px; display: block; }

    /* ‚îÄ‚îÄ Input area ‚îÄ‚îÄ */
    #input-area {
      padding: 0px
      border-top: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.2);
    }

    .input-wrap {
      max-width: 760px; margin: 0 auto;
      display: flex; align-items: flex-end; gap: 10px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 16px; padding: 10px 12px;
      transition: border-color .2s, box-shadow .2s;
    }
    .input-wrap:focus-within {
      border-color: rgba(99,102,241,.5);
      box-shadow: 0 0 0 3px rgba(99,102,241,.1);
    }

    #userInput {
      flex: 1; background: transparent;
      border: none; outline: none;
      color: #f1f5f9; font-size: 14px; line-height: 1.5;
      resize: none; max-height: 160px;
      font-family: 'DM Sans', sans-serif;
    }
    #userInput::placeholder { color: rgba(255,255,255,.3); }
    #userInput::-webkit-scrollbar { width: 3px; }
    #userInput::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); }

    #sendBtn {
      width: 38px; height: 38px; flex-shrink: 0;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all .2s;
      box-shadow: 0 4px 12px rgba(99,102,241,.4);
    }
    #sendBtn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(99,102,241,.5); }
    #sendBtn:active { transform: scale(.97); }
    #sendBtn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

    /* Typing indicator */
    .typing-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: #6366f1; display: inline-block;
      animation: bounce .9s ease-in-out infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: .15s; }
    .typing-dot:nth-child(3) { animation-delay: .3s; }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); opacity: .5; }
      50%       { transform: translateY(-5px); opacity: 1; }
    }

    /* Mobile sidebar toggle */
    #sidebarToggle { display: none; }
    @media (max-width: 640px) {
      #sidebar { position: fixed; z-index: 50; transform: translateX(-100%); }
      #sidebar.open { transform: translateX(0); }
      #sidebarToggle { display: flex; }
    }

    .logout-link {
      display: flex; align-items: center; gap: 6px;
      color: #64748b; font-size: 12px; text-decoration: none;
      padding: 4px 6px; border-radius: 6px; transition: color .2s;
    }
    .logout-link:hover { color: #f87171; }
    .settings-option, .user-badge {
    user-select: none; /* Matnni tanlashni o'chiradi */
    -webkit-user-select: none;
}
    .settings-option:hover {
        background: rgba(255,255,255,0.08);
    }
    /* Light mode uchun mukammal ranglar */
body.light-mode {
    background: #f1f5f9 !important; /* Bir oz kulrangroq fon */
    color: #1e293b !important;
}

body.light-mode #sidebar {
    background: #ffffff !important;
    border-right: 1px solid #e2e8f0;
}

/* AI xabari light mode'da */
body.light-mode .msg-row.ai .msg-bubble {
    background: #ffffff !important;
    border: 1px solid #e2e8f0 !important;
    color: #334155 !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* User xabari light mode'da (ko'k rangni saqlab qoladi) */
body.light-mode .msg-row.user .msg-bubble {
    background: #2563eb !important;
    color: #ffffff !important;
    border: none;
}

/* Pastki yozuv yozish qismi */
body.light-mode #input-area {
    background: #f8fafc !important;
    border-top: 1px solid #e2e8f0;
}

/* Sidebar umumiy strukturasi */
#sidebar {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

.sessions-list {
    flex: 1; /* Suhbatlar ro'yxati o'rtani egallaydi */
    overflow-y: auto;
}

/* Sidebar Footer - hamma narsani pastga tushiradi */
.sidebar-footer {
    margin-top: auto; /* Avtomatik ravishda eng pastga tushadi */
    padding: 12px;
    border-top: 1px solid rgba(255,255,255,.06);
    position: relative;
}

/* Light mode rejimi uchun maxsus ranglar */
body.light-mode {
    background: #f8fafc !important;
    color: #0f172a !important;
}

body.light-mode #sidebar {
    background: #ffffff !important;
    border-right: 1px solid #e2e8f0;
}

/* Light mode da AI va User xabarlari */
body.light-mode .msg-row.ai .msg-bubble {
    background: #f1f5f9 !important;
    color: #1e293b !important;
    border: 1px solid #e2e8f0;
}

body.light-mode .msg-row.user .msg-bubble {
    background: #10b981 !important; /* Yashilroq yoki ko'kroq */
    color: #ffffff !important;
}

/* Sozlamalar menyusi (Rasmda ko'rsatilganidek chap pastga) */
#settingsMenu {
    display: none;
    position: absolute;
    bottom: 75px; /* User badge dan biroz tepada */
    left: 12px;
    width: 230px;
    background: #13131f;
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 12px;
    padding: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    z-index: 1000;
}

body.light-mode #settingsMenu {
    background: #ffffff !important;
    border: 1px solid #e2e8f0 !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
}

body.light-mode .settings-option {
    color: #1e293b !important;
}

/* Belgilanib qolmaslik uchun (Selection error fix) */
.user-badge, .settings-option {
    user-select: none;
    -webkit-user-select: none;
}
</style>
</head>
<body>

<div id="sidebar">
  <div class="sidebar-header">
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="logo-ring">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <span class="brand text-white font-bold text-lg">O'zbekGPT</span>
    </div>
  </div>

  <a href="{% url 'new_session' %}" class="new-chat-btn">
    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" style="margin-right:8px">
      <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
    </svg>
    Yangi suhbat
  </a>

  <div class="sessions-list">
    <p style="font-size:11px;color:#475569;padding:4px 8px 8px;text-transform:uppercase;letter-spacing:.08em;font-weight:600;">Suhbatlar</p>

    {% for session in sessions %}
      <div class="session-item {% if current_session and current_session.id == session.id %}active{% endif %}">
        <a href="?session={{ session.id }}" style="flex:1;text-decoration:none;">
          <div class="session-title">
            <span style="margin-right:6px;">üí¨</span>{{ session.title|truncatechars:30 }}
          </div>
        </a>
        <form method="POST" action="{% url 'delete_session' session.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="del-btn" title="O'chirish">
            <svg width="13" height="13" fill="none" viewBox="0 0 24 24">
              <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </form>
      </div>
    {% empty %}
      <p style="font-size:12px;color:#334155;text-align:center;padding:20px 0;">Hali suhbat yo'q</p>
    {% endfor %}
  </div>

</div>

<div class="sidebar-footer">
    <div id="settingsMenu">
        <div class="settings-option" onclick="toggleDarkMode()">
            <span id="theme-icon">üåô</span> <span id="theme-text">Qora fon</span>
        </div>
        <div class="settings-option" onclick="changeTheme()">
            <span>üåà</span> Ranglar
        </div>
        <div class="settings-option" onclick="resetTheme()">
            <span>üîÑ</span> Reset
        </div>
        <div style="height:1px; background:rgba(255,255,255,0.1); margin:4px 0;"></div>
        <a href="{% url 'logout' %}" style="text-decoration:none; color:#f87171;">
            <div class="settings-option">
                <span>üö™</span> Chiqish
            </div>
        </a>
    </div>

    <div class="user-badge" onclick="toggleSettingsMenu()" style="display:flex; align-items:center; gap:12px; padding:10px; border-radius:12px; background:rgba(255,255,255,0.03); cursor:pointer; user-select:none;">
        <div class="avatar" style="width:35px; height:35px; border-radius:10px; background:linear-gradient(45deg, #6366f1, #a855f7); display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">
            {{ request.user.username|first|upper }}
        </div>
        <div style="flex:1; overflow:hidden;">
            <div style="font-size:14px; font-weight:500; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">
                {{ request.user.username }}
            </div>
            <div style="font-size:11px; opacity:0.5;">Sozlamalar</div>
        </div>
        <div style="opacity:0.3; font-size:10px;">‚ñ≤</div>
    </div>
</div>  

<div id="main">

  <div style="display:none;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.06);background:rgba(0,0,0,.3);" id="topbar">
    <button id="sidebarToggle" onclick="toggleSidebar()" style="background:rgba(255,255,255,.06);border:none;color:#94a3b8;border-radius:8px;padding:7px;cursor:pointer;display:flex;">
      <svg width="18" height="18" fill="none" viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
    <span class="brand text-white font-bold">NexusAI</span>
  </div>

  {% if not current_session %}
  <div id="welcome">
    <div class="welcome-logo">
      <svg width="36" height="36" fill="none" viewBox="0 0 24 24">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <h2 class="text-white text-2xl font-bold text-center">Salom, {{ request.user.username }}! üëã</h2>
    <p style="color:#64748b;font-size:14px;margin-top:8px;text-align:center;">Men matematik, tarix va umumiy savollaringizga javob beraman.</p>

    <div class="suggestion-grid">
      <div class="suggestion-card" onclick="useSuggestion(this)">
        <span class="icon">üßÆ</span>
        Integral hisoblashni tushuntirib ber
      </div>
      <div class="suggestion-card" onclick="useSuggestion(this)">
        <span class="icon">üèõÔ∏è</span>
        Ikkinchi Jahon Urushi qachon boshlangan?
      </div>
      <div class="suggestion-card" onclick="useSuggestion(this)">
        <span class="icon">üìê</span>
        Pifagor teoremasi nima va qanday ishlatiladi?
      </div>
      <div class="suggestion-card" onclick="useSuggestion(this)">
        <span class="icon">üåç</span>
        O'zbekiston tarixi haqida gapirib ber
      </div>
    </div>
  </div>
  {% else %}
  <div id="messages">
    <div class="message-wrap">
      {% for msg in chat_messages %}
        <div class="msg-row {% if msg.role == 'user' %}user{% else %}ai{% endif %}">
          <div class="msg-avatar {% if msg.role == 'user' %}user-av{% else %}ai{% endif %}">
            {% if msg.role == 'user' %}{{ request.user.username|first|upper }}
            {% else %}N{% endif %}
          </div>
          <div class="msg-bubble">
            {% if msg.role == 'assistant' %}
              <script>document.write(marked.parse(`{{ msg.content|escapejs }}`));</script>
            {% else %}
              {{ msg.content|linebreaksbr }}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div id="input-area">
    <div class="input-wrap">
      <textarea
        id="userInput"
        rows="1"
        placeholder="Savolni yozing‚Ä¶"
        oninput="autoResize(this)"
        onkeydown="handleKey(event)"
      ></textarea>
      <button id="sendBtn" onclick="sendMessage()">
        <svg width="17" height="17" fill="none" viewBox="0 0 24 24">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    <p style="text-align:center;font-size:11px;color:#334155;margin-top:8px;">O'zbekGPT xatolar qilishi mumkin. Muhim qarorlar uchun tekshiring.</p>
  </div>
</div>

<script>
  const CSRF = '{{ csrf_token }}';
  let currentSessionId = {% if current_session %}{{ current_session.id }}{% else %}null{% endif %};
  let isThinking = false;

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 160) + 'px';
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  function useSuggestion(el) {
    const text = el.innerText.replace(/^[^\w]+/, '').trim();
    document.getElementById('userInput').value = text;
    sendMessage();
  }

  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
  }

  function scrollBottom() {
    const m = document.getElementById('messages');
    if (m) m.scrollTop = m.scrollHeight;
  }

  function addMessage(role, content) {
    const welcome = document.getElementById('welcome');
    if (welcome) {
      const main = document.getElementById('main');
      welcome.remove();
      const msgDiv = document.createElement('div');
      msgDiv.id = 'messages';
      msgDiv.innerHTML = '<div class="message-wrap"></div>';
      main.insertBefore(msgDiv, document.getElementById('input-area'));
    }

    const wrap = document.querySelector('.message-wrap');
    const isUser = role === 'user';

    const row = document.createElement('div');
    row.className = 'msg-row ' + (isUser ? 'user' : 'ai');
    row.innerHTML = `
      <div class="msg-avatar ${isUser ? 'user-av' : 'ai'}">
        ${isUser ? '{{ request.user.username|first|upper }}' : 'N'}
      </div>
      <div class="msg-bubble">${isUser ? content.replace(/\n/g, '<br>') : marked.parse(content)}</div>
    `;
    wrap.appendChild(row);
    scrollBottom();
    return row.querySelector('.msg-bubble');
  }

  function showTyping() {
    const bubble = addMessage('ai', '');
    bubble.innerHTML = `
      <div class="typing-indicator">
        <span class="typing-dot"></span>
        <span class="typing-dot" style="margin:0 3px"></span>
        <span class="typing-dot"></span>
      </div>
    `;
    return bubble;
  }

  async function sendMessage() {
    if (isThinking) return;
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text) return;

    isThinking = true;
    input.value = '';
    input.style.height = 'auto';
    document.getElementById('sendBtn').disabled = true;

    addMessage('user', text);
    const typingBubble = showTyping();

    try {
      const resp = await fetch('{% url "send_message" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
        body: JSON.stringify({ message: text, session_id: currentSessionId }),
      });
      const data = await resp.json();

      // AI javobini chiqarishda MARKED ishlatamiz
      typingBubble.innerHTML = marked.parse(data.reply);

      if (!currentSessionId) {
        currentSessionId = data.session_id;
        window.history.replaceState({}, '', '?session=' + data.session_id);
        location.reload();
      }

    } catch (err) {
      typingBubble.innerHTML = '‚ùå Xatolik yuz berdi. Qayta urinib ko\'ring.';
    }

    isThinking = false;
    document.getElementById('sendBtn').disabled = false;
    scrollBottom();
    input.focus();
  }

  scrollBottom();

  if (window.innerWidth <= 640) {
    document.getElementById('topbar').style.display = 'flex';
  }
  // 1. Menyuni ochish va yopish
// Menyuni ochish
function toggleSettingsMenu() {
    const menu = document.getElementById('settingsMenu');
    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
}

// Oq va Qora fon logikasi
let isLightMode = localStorage.getItem('isLightMode') === 'true';

function applyTheme() {
    if (isLightMode) {
        document.body.classList.add('light-mode');
        document.getElementById('theme-icon').innerText = "üåô";
        document.getElementById('theme-text').innerText = "Qora fon";
    } else {
        document.body.classList.remove('light-mode');
        document.getElementById('theme-icon').innerText = "‚òÄÔ∏è";
        document.getElementById('theme-text').innerText = "Oq fon";
    }
}
applyTheme(); // Sahifa yuklanganda ishga tushadi

function toggleDarkMode() {
    isLightMode = !isLightMode;
    localStorage.setItem('isLightMode', isLightMode);
    
    const icon = document.getElementById('theme-icon');
    const text = document.getElementById('theme-text');

    if (isLightMode) {
        document.body.classList.add('light-mode');
        icon.innerText = "üåô";
        text.innerText = "Qora fon";
    } else {
        document.body.classList.remove('light-mode');
        icon.innerText = "‚òÄÔ∏è";
        text.innerText = "Oq fon";
    }
}

// Rang effektini o'zgartirish
let currentHue = localStorage.getItem('themeHue') || 0;
document.body.style.filter = `hue-rotate(${currentHue}deg)`;

function changeTheme() {
    currentHue = (parseInt(currentHue) + 60) % 360;
    document.body.style.filter = `hue-rotate(${currentHue}deg)`;
    localStorage.setItem('themeHue', currentHue);
}

function resetTheme() {
    localStorage.clear();
    location.reload();
}

// Menyudan tashqariga bosilganda yopish
window.onclick = function(event) {
    const menu = document.getElementById('settingsMenu');
    if (!event.target.closest('.sidebar-footer')) {
        menu.style.display = 'none';
    }
}
function updateBtnText(light) {
    const icon = document.getElementById('theme-icon');
    const text = document.getElementById('theme-text');
    if (icon) icon.innerText = light ? "üåô" : "‚òÄÔ∏è";
    if (text) text.innerText = light ? "Qora fon" : "Oq fon";
}

function resetTheme() {
    localStorage.clear();
    location.reload();
}

// Tashqariga bosilganda yopish
window.addEventListener('click', function(e) {
    const menu = document.getElementById('settingsMenu');
    const badge = document.querySelector('.user-badge');
    if (menu && !menu.contains(e.target) && !badge.contains(e.target)) {
        menu.style.display = 'none';
    }
});

</script>
</body>
</html>